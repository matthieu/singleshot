<%
  performing = @task.can_complete?(authenticated)
  iframe_url = @task.rendering.render_url(performing, 'task_url'=>task_for_person_url(@task, authenticated))
%>
<% div_for @task do %>
  <div class='header'>
    <h1><%= link_to 'Singleshot', tasks_url, :title=>'Back to tasks list' %></h1>
    <div class='actions'>
      <%= quick_actions(@task) %>
      <%= content_tag 'button', 'More Options', :onclick=>"Singleshot.expand(event, '.header .details', 'Less options')", :class=>'button-to' %>
      <%= button_to 'Completed', task_url(@task, 'task[status]'=>'completed'), :method=>:put, :title=>'Click when task completed' if performing && @task.rendering.use_completion_button?  %>
    </div>
    <div class='vitals'>
      <p class='title'><%= h(@task.title) %></p>
      <p class='info'><%= task_vitals(@task) %></p>
    </div>
    <div class='details' style='display:none'>
      <dl>
        <%= content_tag('dt', 'Description') + content_tag('dd', sanitize(simple_format(@task.description))) if iframe_url %>
        <dt>Priority</dt><dd><%= ['High', 'Medium', 'Low'][@task.priority - 1] %></dd>
        <%= content_tag('dt', 'Due on') + content_tag('dd', relative_date(@task.due_on).humanize) if @task.due_on %>
        <dt>Recent activity</dt>
        <dd>
          <ul class='alternate'><%= content_tag 'li', link_to(image_tag('feed.png') + ' Feed', @alternate[Mime::ATOM], :rel=>'alternate', :title=>'Subscribe to see changes to this task') %><%= content_tag 'li', link_to(image_tag('calendar.png') + ' Calendar', @alternate[Mime::ICS], :rel=>'alternate', :title=>'Add this task to your calendar') %></ul>
          <%= render :file=>'activity/_activities', :locals=>{ :today=>Date.today, :activities=>@task.activities } %>
        </dd>
      </dl>
      <div class='actions'><%= task_actions(@task) %></div>
    </div>
  </div>

  <% if iframe_url %>
    <iframe id='task_frame' src='<%= iframe_url %>'></iframe>
    <%= javascript_tag "Singleshot.setFrameSize('task_frame')" %>
  <% else %>
    <div class='description'><%= sanitize(simple_format(@task.description)) %></div>
  <% end %>
<% end %>
